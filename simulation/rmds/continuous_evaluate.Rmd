---
title: "Evaluation for continuous structure discovery"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
df_print: paged
---
# Overview
Evaluation for continuous structure discovery

```{r setup, echo = FALSE}                                           
knitr::opts_knit$set(root.dir = normalizePath("../"))
# setwd("simulation/")
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
rm(list = ls())
for(i.function in list.files("functions/", full.names = TRUE)) {
  source(i.function)
}
setup()
dir_output <- "results/continuous/"
dir.create(dir_output, recursive = TRUE, showWarnings = TRUE)
```

```{r load data}
# parallel computing
ncores <- 15

load(paste0(dir_output, "tb_sim.RData"))
load(paste0(dir_output, "sparseDOSSA.RData"))
```

```{r evaluate continuous score before correction}
N <- nrow(tb_sim)
registerDoParallel(ncores)
cutoff <- seq(0.5, 0.1, by = -0.1)
results <- foreach(i = 1:N) %dopar% {
  i_simSetup <- tb_sim[i, ]
  mat_otu <- l_sparseDOSSA[[i]]
  for(cor.cutoff in cutoff) {
    fit.continuous <- MMUPHin::continuous.discover(feature.count = mat_otu,
                                                   batch = "batch",
                                                   data = i_simSetup$df_metadata[[1]],
                                                   normalization = "TSS",
                                                   transform = "AST",
                                                   cor.cutoff = cor.cutoff,
                                                   diagnostics = FALSE,
                                                   network = FALSE,
                                                   verbose = FALSE)
    if(is.null(fit.continuous)) next
    if(length(fit.continuous$membership[[1]]) >= i_simSetup$nBatch) break
  }
  if(!is.null(fit.continuous)) {
    correlation <- mat_otu %>% 
      apply(2, MMUPHin:::tss) %>% sqrt() %>% asin %>% 
      t() %>% `%*%`(fit.continuous$consensus.loading[, 1]) %>% 
      cor(i_simSetup$df_metadata[[1]]$score, method = "spearman")
    return(list(cor.cutoff = cor.cutoff,
                fit.continuous = fit.continuous,
                correlation = correlation[1, 1]))
  }
  return(NULL)
}
stopImplicitCluster()
save(results, file = paste0(dir_output, "evaluate_before.RData"))
```

```{r batch correction and continuous discovery}
N <- nrow(tb_sim)
registerDoParallel(ncores)
cutoff <- seq(0.5, 0.1, by = -0.1)
results_correct <- foreach(i = 1:N) %dopar% {
  i_simSetup <- tb_sim[i, ]
  mat_otu <- l_sparseDOSSA[[i]]
  df_metadata <- tb_sim[i, ]$df_metadata[[1]]
  
  mat_otu <- mat_otu %>% 
    MMUPHin::adjust.batch(batch = "batch", 
                          data = df_metadata,
                          diagnostics = FALSE, 
                          verbose = FALSE)
  for(cor.cutoff in cutoff) {
    fit.continuous <- MMUPHin::continuous.discover(feature.count = mat_otu,
                                                   batch = "batch",
                                                   data = i_simSetup$df_metadata[[1]],
                                                   transform = "AST",
                                                   cor.cutoff = cor.cutoff,
                                                   diagnostics = FALSE,
                                                   network = FALSE,
                                                   verbose = FALSE)
    if(is.null(fit.continuous)) next
    if(length(fit.continuous$membership[[1]]) >= i_simSetup$nBatch) break
  }
  if(!is.null(fit.continuous)) {
    correlation <- mat_otu %>% 
      apply(2, MMUPHin:::tss) %>% sqrt() %>% asin %>% 
      t() %>% `%*%`(fit.continuous$consensus.loading[, 1]) %>% 
      cor(i_simSetup$df_metadata[[1]]$score, method = "spearman")
    return(list(cor.cutoff = cor.cutoff,
                fit.continuous = fit.continuous,
                correlation = correlation[1, 1]))
  }
  return(NULL)
}
stopImplicitCluster()
save(results_correct, file = paste0(dir_output, "evaluate_after.RData"))
```

```{r sanity check}
registerDoParallel(ncores)
R2 <- foreach(i = 1:N) %dopar% {
  i_simSetup <- tb_sim[i, ]
  mat_otu <- l_sparseDOSSA[[i]]
  D <- mat_otu %>% apply(2, MMUPHin:::tss) %>% 
    phyloseq::otu_table(taxa_are_rows = TRUE) %>% 
    phyloseq::distance(method = "bray")
  R2_score <- vegan::adonis(D ~ score, data = i_simSetup$df_metadata[[1]], permutations = 2)
  R2_batch <- vegan::adonis(D ~ batch, data = i_simSetup$df_metadata[[1]], permutations = 2)
  return(c("R2_score" = R2_score$aov.tab["score", "R2"],
           "R2_batch" = R2_batch$aov.tab["batch", "R2"]))
}
stopImplicitCluster()
save(R2, file = paste0(dir_output, "R2_before.RData"))
registerDoParallel(ncores)
R2_correct <- foreach(i = 1:N) %dopar% {
  i_simSetup <- tb_sim[i, ]
  mat_otu <- l_sparseDOSSA[[i]]
  mat_otu <- mat_otu %>% 
    MMUPHin::adjust.batch(batch = "batch", 
                          data = i_simSetup$df_metadata[[1]],
                          diagnostics = FALSE, 
                          verbose = FALSE)
  
  D <- mat_otu %>% apply(2, MMUPHin:::tss) %>% 
    phyloseq::otu_table(taxa_are_rows = TRUE) %>% 
    phyloseq::distance(method = "bray")
  R2_score <- vegan::adonis(D ~ score, data = i_simSetup$df_metadata[[1]], permutations = 2)
  R2_batch <- vegan::adonis(D ~ batch, data = i_simSetup$df_metadata[[1]], permutations = 2)
  return(c("R2_score" = R2_score$aov.tab["score", "R2"],
           "R2_batch" = R2_batch$aov.tab["batch", "R2"]))
}
stopImplicitCluster()
save(R2_correct, file = paste0(dir_output, "R2_after.RData"))
```

