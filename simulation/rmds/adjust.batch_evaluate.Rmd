---
title: "Evaluation for adjust.batch function"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
df_print: paged
---
# Overview
Evaluate for batch adjustment function

```{r setup, echo = FALSE}                                           
knitr::opts_knit$set(root.dir = normalizePath("../"))
# setwd("simulation/")
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
rm(list = ls())
for(i.function in list.files("functions/", full.names = TRUE)) {
  source(i.function)
}
setup()
dir_output <- "results/adjust.batch/"
dir.create(dir_output, recursive = TRUE, showWarnings = TRUE)
```

```{r load data}
ncores <- 20
load(paste0(dir_output, "tb_sim.RData"))
load(paste0(dir_output, "sparseDOSSA.RData"))
tb_results <- tb_sim %>% 
  dplyr::mutate(otu_count = l_sparseDOSSA) %>% 
  dplyr::mutate(success = sapply(otu_count, class) == "matrix")
mean(tb_results$success)
# View(tb_results %>% dplyr::filter(!success))
# i_simSetup <- tb_results %>% dplyr::filter(!success) %>% dplyr::slice(1)
tb_results <- tb_results %>% 
  dplyr::filter(success)
# Total number iterations. Set so easy to have testing run
N <- nrow(tb_results)
```

```{r calculate R2 before adjustment}
registerDoParallel(ncores)
l_permanova_before <- foreach(i = 1:N) %dopar% {
  i_result <- tb_results[i, ]
  phylo_tmp <- phyloseq::phyloseq(
    otu_table(i_result$otu_count[[1]], taxa_are_rows = TRUE),
    sample_data(i_result$df_metadata[[1]])
  ) %>% prune_taxaSamples() %>%
    transform_sample_counts(MMUPHin:::tss)

  distance <- phyloseq::distance(phylo_tmp, method = "bray")
  list(batch = vegan::adonis(distance ~ batch,
                             data = sample_data2(phylo_tmp),
                             permutations = 2),
       positive_control = vegan::adonis(distance ~ positive_control,
                                        data = sample_data2(phylo_tmp),
                                        permutations = 2),
       negative_control = vegan::adonis(distance ~ negative_control,
                                        data = sample_data2(phylo_tmp),
                                        permutations = 2))
}
stopImplicitCluster()
save(l_permanova_before, file = paste0(dir_output, "permanova_before.RData"))
# load(paste0(dir_output, "permanova_before.RData"))
# classes <- sapply(l_permanova_before, function(i) sapply(i, class))
```

```{r batch adjustment}
registerDoParallel(ncores)
l_adjust.batch <- foreach(i = 1:N) %dopar% {
  i_result <- tb_results[i, ]
  otu_adjust <- MMUPHin::adjust.batch(
    feature.count = i_result$otu_count[[1]],
    batch = "batch",
    covariates = c("positive_control", "negative_control"),
    data = i_result$df_metadata[[1]],
    zero.inflation = TRUE,
    pseudo.count = 0.5,
    diagnostics = FALSE,
    verbose = FALSE
  )
  otu_adjust_ComBat <- sva::ComBat(
    dat = log10(i_result$otu_count[[1]] + 0.5),
    batch = i_result$df_metadata[[1]]$batch,
    mod = model.matrix(~., i_result$df_metadata[[1]][, -1])
  ) %>%
    `^`(10, .)
  list(otu_adjust = otu_adjust,
       otu_adjust_ComBat = otu_adjust_ComBat)
}
stopImplicitCluster()
save(l_adjust.batch, file = paste0(dir_output, "adjust.batch.RData"))
# load(paste0(dir_output, "adjust.batch.RData"))
```

```{r calculate R2 after adjustment}
registerDoParallel(ncores)
l_permanova_after <- foreach(i = 1:N) %dopar% {
  i_result <- tb_results[i, ]
  
  phylo_tmp <- phyloseq::phyloseq(
    otu_table(l_adjust.batch[[i]]$otu_adjust, taxa_are_rows = TRUE),
    sample_data(i_result$df_metadata[[1]])
  ) %>% prune_taxaSamples() %>%
    transform_sample_counts(MMUPHin:::tss)
  distance <- phyloseq::distance(phylo_tmp, method = "bray")
  
  list(batch = vegan::adonis(distance ~ batch, 
                                 data = sample_data2(phylo_tmp),
                                 permutations = 2)),
       positive_control = vegan::adonis(distance ~ positive_control, 
                                            data = sample_data2(phylo_tmp),
                                            permutations = 2),
       negative_control = vegan::adonis(distance ~ negative_control, 
                                            data = sample_data2(phylo_tmp),
                                            permutations = 2))
}
stopImplicitCluster()
save(l_permanova_after, file = paste0(dir_output, "permanova_after.RData"))
registerDoParallel(ncores)
l_permanova_afterComBat <- foreach(i = 1:N) %dopar% {
  i_result <- tb_results[i, ]

  phylo_tmp <- phyloseq::phyloseq(
    otu_table(l_adjust.batch[[i]]$otu_adjust_ComBat, taxa_are_rows = TRUE),
    sample_data(i_result$df_metadata[[1]])
  ) %>% prune_taxaSamples() %>%
    transform_sample_counts(MMUPHin:::tss)
  distance <- phyloseq::distance(phylo_tmp, method = "bray")

  list(batch = vegan::adonis(distance ~ batch,
                             data = sample_data2(phylo_tmp),
                             permutations = 2),
       positive_control = vegan::adonis(distance ~ positive_control,
                                        data = sample_data2(phylo_tmp),
                                        permutations = 2),
       negative_control = vegan::adonis(distance ~ negative_control,
                                        data = sample_data2(phylo_tmp),
                                        permutations = 2))
}
stopImplicitCluster()
save(l_permanova_afterComBat, file = paste0(dir_output, "permanova_afterComBat.RData"))
```
