---
title: "Evaluation for lm.meta function"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
df_print: paged
---
# Overview
Evaluation for lm.meta function

```{r setup, echo = FALSE}                                           
knitr::opts_knit$set(root.dir = normalizePath("../"))
# setwd("simulation/")
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
rm(list = ls())
for(i.function in list.files("functions/", full.names = TRUE)) {
  source(i.function)
}
setup()
dir_output <- "results/lm.meta/"
dir.create(dir_output, recursive = TRUE, showWarnings = TRUE)
```

```{r load data}
ncores <- 20

load(paste0(dir_output, "tb_simCont.RData"))
load(paste0(dir_output, "tb_simDisc.RData"))
load(paste0(dir_output, "sparseDOSSA_cont.RData"))
l_sparseDOSSA_cont <- l_sparseDOSSA
load(paste0(dir_output, "sparseDOSSA_disc.RData"))
l_sparseDOSSA_disc <- l_sparseDOSSA

l_tb_results <- list(
  cont = tb_simCont %>% 
    dplyr::mutate(otu_count = l_sparseDOSSA_cont,
                  success = sapply(otu_count, class) == "matrix"),
  disc = tb_simDisc %>% 
    dplyr::mutate(otu_count = l_sparseDOSSA_disc,
                  success = sapply(otu_count, class) == "matrix")
)

l_tb_results %>% 
  purrr::map_dbl(function(tb_results) mean(tb_results$success))
# View(tb_results %>% dplyr::filter(!success))
# i_simSetup <- tb_results %>% dplyr::filter(!success) %>% dplyr::slice(1)
l_tb_results <- l_tb_results %>% 
  purrr::map(function(tb_results) {
    tb_results %>% dplyr::filter(success)
  })
# Total number iterations. Set so easy to have testing run
# N <- l_tb_results %>% purrr::map_dbl(nrow)
N <- c("cont" = 20, "disc" = 20)
```

```{r run meta-analysis before batch adjustment}
for(metadata_type in c("cont", "disc")){
  registerDoParallel(ncores)
  tb_results <- l_tb_results[[metadata_type]]
  l_lm.meta_before <- foreach(i = 1:N[metadata_type]) %dopar% {
    i_result <- tb_results[i, ]
    fit_lm.meta <- MMUPHin::lm.meta(feature.count = i_result$otu_count[[1]],
                                    batch = "batch",
                                    exposure = "exposure",
                                    data = i_result$df_metadata[[1]],
                                    normalization = "TSS",
                                    transform = "AST",
                                    directory = paste0(dir_output, "MMUPHin/", i, "/"),
                                    forest.plots = FALSE,
                                    verbose = FALSE)
    return(fit_lm.meta$meta.results)
  }
  stopImplicitCluster()
  save(l_lm.meta_before, 
       file = paste0(dir_output, 
                     "lm.meta_", 
                     metadata_type,
                     "_before.RData"))
}
```

```{r batch adjustment}
# for(metadata_type in c("cont", "disc")){
#   registerDoParallel(ncores)
#   tb_results <- l_tb_results[[metadata_type]]
#   l_adjust.batch <- foreach(i = 1:N[metadata_type]) %dopar% {
#     i_result <- tb_results[i, ]
#     otu_adjust <- MMUPHin::adjust.batch(
#       feature.count = i_result$otu_count[[1]],
#       batch = "batch",
#       covariates = c("exposure"),
#       data = i_result$df_metadata[[1]],
#       zero.inflation = TRUE,
#       pseudo.count = 0.5,
#       diagnostics = FALSE,
#       verbose = FALSE
#     )
#     return(otu_adjust)
#   }
#   stopImplicitCluster()
#   save(l_adjust.batch, file = paste0(dir_output, "adjust.batch_",
#                                      metadata_type, ".RData"))
# }
```

```{r run meta-analysis after batch adjustment}
# for(metadata_type in c("cont", "disc")){
#   registerDoParallel(ncores)
#   tb_results <- l_tb_results[[metadata_type]]
#   load(paste0(dir_output, "adjust.batch_", metadata_type, ".RData"))
#   l_lm.meta_after <- foreach(i = 1:N[metadata_type]) %dopar% {
#     i_result <- tb_results[i, ]
#     fit_lm.meta <- MMUPHin::lm.meta(feature.count = l_adjust.batch[[i]],
#                                     batch = "batch",
#                                     exposure = "exposure",
#                                     data = i_result$df_metadata[[1]],
#                                     normalization = "TSS",
#                                     transform = "AST",
#                                     directory = paste0(dir_output, "MMUPHin/", i, "/"),
#                                     forest.plots = TRUE,
#                                     verbose = FALSE)
#     return(fit_lm.meta$meta.results)
#   }
#   stopImplicitCluster()
#   save(l_lm.meta_after, 
#        file = paste0(dir_output, 
#                      "lm.meta_", 
#                      metadata_type,
#                      "_after.RData"))
# }
```
