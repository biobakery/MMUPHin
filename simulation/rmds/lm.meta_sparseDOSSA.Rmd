---
title: "sparseDOSSA simulation for lm.meta function"
author: "Siyuan Ma"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
html_document:
df_print: paged
---
# Overview
sparseDOSSA simulation for lm.meta function

```{r setup, echo = FALSE}                                           
knitr::opts_knit$set(root.dir = normalizePath("../"))
# setwd("simulation/")
```
```{r setup2, message=FALSE, warning=FALSE, echo = FALSE}
rm(list = ls())
for(i.function in list.files("functions/", full.names = TRUE)) {
  source(i.function)
}
setup()
dir_output <- "results/lm.meta/"
dir.create(dir_output, recursive = TRUE, showWarnings = TRUE)
dir.create(paste0(dir_output, "sparseDOSSA_sets/"), recursive = TRUE, showWarnings = TRUE)
```

```{r simulation parameters}
# parallel computing
ncores <- 20
# sample size
# nBatch <- c(2, 4, 6, 8)
nBatch <- c(2)
# nSample <- c(200, 1000)
nSample <- 200
# feature size
# nMicrobe <- c(200, 1000)
nMicrobe <- 200
# spikeMicrobes <- c(0.1, 0.2, 0.5)
spikeMicrobes <- 0.2
# metadata specification
tb_metadataType <- tibble::tibble(
  metadata_type = list(c("batch" = "factor",
                         "exposure" = "factor")
                       # c("batch" = "factor",
                       #   "exposure" = "numeric"))
  ))
tb_effectSize <- tidyr::crossing(batch = c(0, 1, 2, 3, 4, 5),
                                 exposure = c(1, 2, 3, 4, 5))
effectSize <- tibble::tibble(effectSize = 
                               (1:nrow(tb_effectSize)) %>% 
                               purrr::map(function(i) unlist(tb_effectSize[i, ])))
# replicates
rep <- 1:10
# metadata simulation
fDummyData <- TRUE
fDummyDirection <- TRUE
# additional setup
noZeroInflate <- FALSE
scalePercentZeros <- c(0.5)

tb_simSetup <- tidyr::crossing(
  rep,
  nBatch,
  nSample,
  nMicrobe,
  spikeMicrobes,
  noZeroInflate,
  scalePercentZeros,
  tb_metadataType,
  effectSize
)
```

```{r simulate metadata}
set.seed(1)
exposure <- function(is_factor, n) { # helper funciton for simulating exposure metadata
  if(is_factor) return(rbinom(n = n, size = 1, prob = 0.5))
  else return(runif(n = n, min = -1, max = 1))
}
tb_sim <- tb_simSetup %>% 
  dplyr::group_by(1:n()) %>% 
  dplyr::mutate(df_metadata = list(
    data.frame(batch = sample.int(nBatch, size = nSample, replace = TRUE) %>%
                 as.factor(),
               exposure = exposure(is_factor = metadata_type[[1]]["exposure"] == "factor",
                                   n = nSample) %>% as.numeric(),
               row.names = paste0("Sample", 1:nSample))),
    spikein.mt = 
        create_effectSize(effectSize = effectSize[[1]],
                          df_metadata = df_metadata[[1]],
                          metadata_type = c("batch" = "factor",
                                            "exposure" = "numeric"),
                          fDummyData = fDummyData,
                          fDummyDirection = fDummyDirection) %>% 
      create_spikein.mt_lm.meta(number_features = nMicrobe,
                                percent_spiked = spikeMicrobes,
                                effectSize = .,
                                seed = `1:n()`) %>%
      list()) %>% 
  dplyr::ungroup()

# sanity_check <- tb_sim %>% 
#   dplyr::group_by(1:n()) %>% 
#   dplyr::summarise(mean_exposure = mean(as.numeric(df_metadata[[1]]$exposure)),
#                    sd_exposure = sd(as.numeric(df_metadata[[1]]$exposure)),
#                    exposure_type = metadata_type[[1]]["exposure"])
save(tb_sim, file = paste0(dir_output, "tb_sim.RData"))
```

```{r run sparseDOSSA}
N <- nrow(tb_sim)
registerDoParallel(ncores)
l_sparseDOSSA <- foreach(i = 1:N) %dopar% {
  i_simSetup <- tb_sim[i, ]
  
  otu_count <- sparseDOSSA::sparseDOSSA(
    number_features = i_simSetup$nMicrobe,
    number_samples = i_simSetup$nSample,
    UserMetadata = 
      create_metadataMatrix(df_metadata = i_simSetup$df_metadata[[1]],
                            metadata_type = c("batch" = "factor",
                                              "exposure" = "numeric"),
                            fDummyData = fDummyData,
                            fDummyDirection = fDummyDirection),
    spikein.mt = i_simSetup$spikein.mt[[1]] %>% 
      dplyr::group_by(feature) %>% 
      dplyr::mutate(metadata = paste(metadata, collapse = ";"), 
                    strength = paste(strength, collapse = ";")) %>% 
      dplyr::slice(1) %>%  
      dplyr::ungroup(),
    noZeroInflate = i_simSetup$noZeroInflate,
    scalePercentZeros = i_simSetup$scalePercentZeros,
    percent_spiked = i_simSetup$spikeMicrobes,
    seed = i_simSetup$`1:n()`,
    minLevelPercent = 0,
    write_table = FALSE,
    verbose = FALSE) %>%
    extract_sparseDOSSA() %>%
    extract2("features")
  otu_count %>% data.frame() %>% 
    cbind(data.frame(Features = rownames(otu_count)), .) %>% 
    readr::write_tsv(path = paste0(dir_output, "sparseDOSSA_sets/", i, ".tsv"))
  return(otu_count)
}
stopImplicitCluster()
save(l_sparseDOSSA, file = paste0(dir_output, "sparseDOSSA.RData"))
```
